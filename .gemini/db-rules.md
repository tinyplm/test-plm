# Database Schema Rules
Quarkus + Hibernate ORM + Flyway (PostgreSQL)

The database schema is the single source of truth.
Hibernate validates schema but never generates or modifies it.

------------------------------------------------------------

## 1. Core Principles

- All schema changes MUST be done using Flyway migrations.
- Existing migrations are immutable.
- SQL must be explicit and deterministic.
- Schema must work on both empty and populated databases.
- ORM annotations must match database definitions exactly.

Production setting:

quarkus.hibernate-orm.database.generation=validate

------------------------------------------------------------

## 2. Naming Conventions

### Tables
- snake_case
- singular nouns preferred

Examples:
app_user
order_item
payment_transaction

### Columns
snake_case only.

### Constraint Naming (MANDATORY)

Primary key:
pk_<table>

Foreign key:
fk_<from_table>_<to_table>

Unique constraint:
uk_<table>_<column>

Index:
idx_<table>_<column>

------------------------------------------------------------

## 3. Required Standard Columns

Every main table must include:

id UUID NOT NULL
created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL
updated_at TIMESTAMP WITHOUT TIME ZONE NOT NULL
version INTEGER NOT NULL DEFAULT 0
deleted BOOLEAN NOT NULL DEFAULT FALSE

Primary key example:

CONSTRAINT pk_<table> PRIMARY KEY (id)

------------------------------------------------------------

## 4. Allowed Data Types

Identifiers:
UUID

Versioning:
INTEGER

Timestamps:
TIMESTAMP WITHOUT TIME ZONE

Flags:
BOOLEAN

Bounded text:
VARCHAR(n)

Decimals:
NUMERIC(p,s)

------------------------------------------------------------

## 5. Prohibited Types / Patterns

DO NOT USE:

- SERIAL or BIGSERIAL
- VARCHAR without length
- TEXT for identifiers
- TIMESTAMP WITH TIME ZONE
- implicit sequences
- ORM-generated schema SQL

If identity columns are required:

GENERATED BY DEFAULT AS IDENTITY

------------------------------------------------------------

## 6. Foreign Key Rules

- FK columns should be NOT NULL unless justified.
- Every FK must have an index.
- Constraint names must be explicit.

Example:

customer_id UUID NOT NULL,

CONSTRAINT fk_order_customer
FOREIGN KEY (customer_id)
REFERENCES customer(id);

CREATE INDEX idx_order_customer_id
ON orders(customer_id);

------------------------------------------------------------

## 7. Nullability Rules

Default rule:

NULL is forbidden unless explicitly required.

When adding NOT NULL columns, use staged migration:
1. add nullable column
2. backfill data
3. set NOT NULL

------------------------------------------------------------

## 8. Index Rules

Indexes are required for:

- foreign keys
- frequently filtered columns
- soft delete filtering

Soft delete index:

CREATE INDEX idx_<table>_deleted
ON <table>(deleted);

------------------------------------------------------------

## 10. Optimistic Locking

Hibernate:

@Version Integer version;

Database:

version INTEGER NOT NULL DEFAULT 0

Must never be nullable.

------------------------------------------------------------

## 11. UUID Rules

UUID columns MUST use PostgreSQL UUID type.
Never store UUID as VARCHAR.
UUID generation occurs in application layer.

------------------------------------------------------------

## 12. Disallowed Operations

AI tools and developers must NOT generate:

- DROP TABLE
- DROP COLUMN without staged migration
- table recreation
- destructive ALTER in same migration

Destructive changes require multi-step rollout.

------------------------------------------------------------

## 13. Schema Ownership Model

Flyway = schema owner
Hibernate = schema validator

Entity change â†’ mandatory Flyway migration.

------------------------------------------------------------

## 14. Migration Acceptance Checklist

Before committing:

- constraint names explicit
- indexes created for FK
- NOT NULL changes staged
- migration backward compatible
- entity mapping matches schema
- migration runs successfully on existing DB

------------------------------------------------------------
